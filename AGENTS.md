# AGENTS.md

Документация по архитектуре агентов для проекта **Pharma Price Parser**

## 1. Общая схема

```
┌───────────────────┐        ┌──────────────────────┐        ┌────────────────────────┐
│   CSV‑ридер       │──URLs──▶  **IngestionAgent**  │──DF──▶  **InsightsAgent**      │
│  (pandas)         │        │  (LangChain + LLM)   │        │  (LangChain + LLM)     │
└───────────────────┘        └──────────────────────┘        └────────────────────────┘
```

* **IngestionAgent** ― извлекает **все** продукты, найденные на HTML‑странице, и нормализует данные.
* **InsightsAgent** ― даёт аналитические выводы по DataFrame на пользовательский запрос.

Обе цепочки построены с помощью **LangChain** и **OpenAI Chat Completions API**.

---

## 2. IngestionAgent

| Параметр            | Значение                                                                                                              |
| ------------------- | --------------------------------------------------------------------------------------------------------------------- |
| **Задача (role)**   | «Извлеки **все** объекты `sku`, `manufacturer`, `price` из переданного HTML‑текста фарм‑товаров и верни JSON‑массив.» |
| **LLM**             | `ChatOpenAI(model_name="gpt-4o-mini", temperature=0.0)`                                                               |
| **Инструменты**     | • `requests` + `BeautifulSoup` для скачивания и очистки DOM<br>• LangChain `Tool` «python\_repl» для post‑processing  |
| **Память**          | Отсутствует (stateless)                                                                                               |
| **Вывод**           | `StructuredOutputParser` → **массив** объектов `{"sku": str, "manufacturer": str, "price": float}`                    |
| **Ошибки / ретраи** | LangChain `RetryWithErrorHandler`, макс. 3 повтора, экспоненциальный back‑off                                         |

### Prompt‑template

```jinja2
Ты — эксперт‑фармацевт и веб‑скрейпер.
Проанализируй HTML‑контент страницы и верни JSON‑массив, где каждый элемент описывает один товар:
[
  {
    "sku": "<полное название товара без формы выпуска>",
    "manufacturer": "<производитель>",
    "price": <цена в числовом виде без валюты>
  },
  ... (для каждого товара на странице)
]

<HTML>{{ html_text }}</HTML>

Только массив JSON, без комментариев.
```

> **Важно:** одна HTML‑страница может содержать несколько товаров (пример — листинг в интернет‑аптеке). IngestionAgent обязан вернуть **все** найденные товары, иначе данные будут неполными.

---

## 3. InsightsAgent

| Параметр          | Значение                                                                                                                                                 |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Задача (role)** | «Отвечай на аналитические вопросы, используя DataFrame с колонками `sku`, `manufacturer`, `price`. При необходимости пиши код на Python и исполняй его.» |
| **LLM**           | `ChatOpenAI(model_name="gpt-4o-mini", temperature=0.2)`                                                                                                  |
| **Инструменты**   | • LangChain `PythonAstREPLTool` с контекстом, содержащим загруженный DataFrame (`df`)                                                                    |
| **Память**        | `ConversationBufferMemory` (чтобы помнить предыдущие вопросы‑ответы)                                                                                     |
| **Вывод**         | Текстовое объяснение + (опционально) табличный/графический результат, сгенерированный кодом                                                              |

### Prompt‑template (сокращённая)

````jinja2
Ты — фармацевт‑аналитик данных.
Тебе доступен объект pandas DataFrame `df` со столбцами sku, manufacturer, price.
Отвечай на вопрос пользователя, применяя код Python внутри текстовых блоков ```python … ```
Если код что‑то выводит (таблицу или график), покажи результат пользователю.
В конце — краткий вывод.

Вопрос: {{ user_question }}
````

LangChain автоматически интерпретирует блоки `python` через `PythonAstREPLTool`, а текст возвращает пользователю.

---


## 4. Переменные окружения

| Переменная       | Описание                                   | Пример                  |
| ---------------- | ------------------------------------------ | ----------------------- |
| `OPENAI_API_KEY` | ключ доступа к OpenAI Chat Completions API | `sk-...`                |
| `PROXY` *(опц.)* | прокси для outbound HTTP                   | `http://127.0.0.1:8080` |

---
